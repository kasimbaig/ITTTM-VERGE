

<div class="naval-dashboard p-4 overflow-x-hidden">
  <!-- Dashboard Tabs - Positioned above the header -->

  <div class="command-header mt-12">
    <div class="command-title-block">
      <i class="fa-solid fa-chart-pie"></i>
      <div>
        <h2>Naval Fleet Maintenance Dashboard</h2>
        <p>Comprehensive fleet maintenance overview and analytics</p>
      </div>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div class="dashboard-container w-full max-w-full" *ngIf="activeTab === 'dashboard'">
    <!-- KPI Cards Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 mb-8 w-full max-w-full">
      <div
        class="group relative bg-white/80 backdrop-blur-sm rounded-2xl shadow-md hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 ease-in-out overflow-hidden border border-gray-200/50 hover:border-blue-300/50"
        *ngFor="let metric of kpiMetrics"
      >
        <!-- Card Content -->
        <div class="relative p-8 h-full flex flex-col items-center justify-center gap-4">
          <!-- Icon and Value Row -->
          <div class="flex items-center gap-4">
            <!-- Icon -->
            <div class="p-3 rounded-xl bg-linear-to-br from-blue-50 to-indigo-100 group-hover:from-blue-100 group-hover:to-indigo-200 transition-all duration-300 shadow-sm">
              <i
                class="pi text-3xl transition-transform duration-300 group-hover:scale-110"
                [ngClass]="metric.iconClass"
                [style.color]="metric.iconColor || '#4f46e5'"
              ></i>
            </div>

            <!-- Value -->
            <h2
              class="text-4xl font-bold transition-all duration-300 group-hover:scale-105"
              [style.color]="metric.valueColor || '#1f2937'"
            >
              {{ metric.value }}
            </h2>
          </div>

          <!-- Title -->
          <p class="text-sm font-semibold text-gray-600 text-center group-hover:text-gray-800 transition-colors duration-300">
            {{ metric.title }}
          </p>
        </div>

        <!-- Bottom Border Accent -->
        <div class="absolute bottom-0 left-0 right-0 h-1 bg-linear-to-r from-blue-500 via-purple-500 to-pink-500 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-500 origin-left"></div>
      </div>
    </div>

    <!-- Filters -->
    <!-- <div class="dashboard-header w-full max-w-full">
      <div class="filter-group">
        <p-dropdown [options]="commands" [(ngModel)]="selectedCommand" placeholder="Command"
          optionLabel="label" optionValue="value" (onChange)="onCommandChange()" [showClear]="true" [filter]="true" [filterBy]="'label'"
          styleClass="filter-dropdown" [filter]="true" [filterBy]="'label'"></p-dropdown>

        <p-dropdown [options]="filteredShips" [(ngModel)]="selectedShip" placeholder="Ship" optionLabel="label"
          optionValue="value" [disabled]="!selectedCommand" (onChange)="onShipChange()" [showClear]="true" [filter]="true" [filterBy]="'label'"
          styleClass="filter-dropdown" [filter]="true" [filterBy]="'label'"></p-dropdown>

        <p-dropdown [options]="departments" [(ngModel)]="selectedDept" placeholder="Department"
          optionLabel="label" optionValue="value" [disabled]="!selectedShip" (onChange)="onDeptChange()"
          [showClear]="true" styleClass="filter-dropdown" [filter]="true" [filterBy]="'label'"></p-dropdown>

        <button pButton label="Apply" icon="pi pi-check" (click)="applyFilters()" class="p-ml-2 btn-app"></button>
        <button pButton label="Clear" icon="pi pi-times" (click)="clearFilters()" class="p-ml-2 btn-app"></button>
      </div>
    </div> -->

    <div class="w-full p-3">
      <!-- <div class="w-full ">
        <app-ocrc [menuExpanded]="menuExpanded"></app-ocrc>
      </div> -->
      <div class="chart-container mt-3">
        <app-defect-list
      [command]="selectedCommand !== null ? selectedCommand.toString() : null"
      [ship]="selectedShip !== null ? selectedShip.toString() : null"
      [dept]="selectedDept !== null ? selectedDept.toString() : null"
    ></app-defect-list>
      </div>
    </div>

    <div class="charts-section w-full max-w-full mt-4">
      <div class="chart-container">
        <app-opdef [command]="selectedCommand !== null ? selectedCommand.toString() : null"
          [ship]="selectedShip !== null ? selectedShip.toString() : null"
          [dept]="selectedDept !== null ? selectedDept.toString() : null" [dateRange]="dateRange"></app-opdef>
      </div>
      <div class="chart-container">
        <app-frequent-defects [chartData]="frequentDefectData"></app-frequent-defects>
      </div>
    </div>
   
    <app-projection-chart ></app-projection-chart>
    <!-- Fleet Status Section -->
     <div class="p-4 rounded-xl w-full max-w-full">

       <div class="fleet-status-header-actions w-full max-w-full">
         <h2>Fleet Status</h2>
         <div class="action-buttons">
           <button pButton icon="pi pi-plus" label="Add Defect" class="btn-primary" (click)="addNewDefect()"></button>
           <button pButton icon="pi pi-book" label="Log Maintenance" class="btn-primary"
             (click)="logMaintenance()"></button>
           <button pButton icon="pi pi-eye" label="View Equipment Fit" class="btn-primary"
             (click)="viewEquipmentFit()"></button>
           <button *ngIf="isApprover" pButton icon="pi pi-check-circle" label="Approve Plan" class="btn-primary"
             (click)="showApprovePlanDialog = true"></button>
         </div>
       </div>
   
       <!-- Fleet Status Table -->
       <table border="1" class="w-full mb-5 border-collapse border border-gray-300 max-w-full">
         <thead>
           <tr class="border border-gray-300">
             <th class="border border-gray-300">Ship</th>
             <th class="border border-gray-300">Readiness</th>
             <th class="border border-gray-300">Open Defects</th>
             <th class="border border-gray-300">Next Maintenance</th>
             <th class="border border-gray-300">Status</th>
           </tr>
         </thead>
         <tbody>
           <tr *ngFor="let ship of fleetStatus" class="border border-gray-300">
             <td class="border border-gray-300">{{ ship.ship }}</td>
             <td class="border border-gray-300">
               <p-progressBar [value]="ship.readiness || 0" styleClass="custom-progress"
                 [showValue]="true"></p-progressBar>
             </td>
             <td class="border border-gray-300">{{ ship.defects }}</td>
             <td class="border border-gray-300">{{ ship.maintenance }}</td>
             <td class="border border-gray-300">
               <span class="status-badge" [ngClass]="getStatusClass(ship.readiness)">
                 <i class="pi"
                   [ngClass]="ship.readiness >=90 ? 'pi-check-circle' : (ship.readiness>=75 ? 'pi-exclamation-circle':'pi-times-circle')"></i>
                 {{ ship.readiness >=90 ? 'Operational' : (ship.readiness>=75 ? 'Limited' : 'In Maintenance') }}
               </span>
             </td>
           </tr>
           <tr *ngIf="!fleetStatus || fleetStatus.length === 0" class="border border-gray-300">
             <td colspan="5" class="p-text-center table-placeholder border border-gray-300">
               <i class="pi pi-database"></i>
               <p>No fleet status data available.</p>
             </td>
           </tr>
         </tbody>
       </table>
     </div>
  </div>
</div>



<!-- Dialogs -->

<!-- Add New Defect Dialog using Reusable Form -->
<app-add-form
  *ngIf="showDefectsFormDialog"
  [open]="showDefectsFormDialog"
  [formConfig]="defectsFormConfig"
  [formData]="newDefect"
  [isSingleColumn]="true"
  [fromTitle]="'Add New Defect'"
  [submitLabel]="'Submit Defect'"
  (onOpenChange)="showDefectsFormDialog = $event"
  (onSubmit)="handleDefectsFormSubmit($event)"
></app-add-form>

<!-- Log Maintenance Dialog -->
<p-dialog header="Log Maintenance Activity" [(visible)]="showLogMaintenanceDialog"
  [style]="{width: '60vw', maxWidth: '90vw'}" styleClass="custom-dialog"
  [breakpoints]="{'960px': '75vw', '640px': '90vw'}" [contentStyle]="{'max-height': '80vh', }">

  <div class="dialog-content p-5">
    <!-- Maintenance Type -->
    <div class="flex items-center mb-4">
      <label for="maintenanceType" class="w-56 font-bold text-left">Maintenance Type <span class="required-asterisk">*</span></label>
      <p-dropdown inputId="maintenanceType" [options]="maintenanceTypeOptions"
        [(ngModel)]="maintenanceLog.maintenanceType" placeholder="Select Type" optionLabel="label" optionValue="value"
        [required]="true" styleClass="drop flex-1"></p-dropdown>
    </div>

    <!-- Maintenance Frequency -->
    <div class="flex items-center mb-4">
      <label for="maintenanceFrequency" class="w-56 font-bold text-left">Frequency <span class="required-asterisk">*</span></label>
      <p-dropdown inputId="maintenanceFrequency" [options]="maintenanceFrequencyOptions"
        [(ngModel)]="maintenanceLog.frequency" placeholder="Select Frequency" optionLabel="label" optionValue="value"
        [required]="true" styleClass="drop flex-1"></p-dropdown>
    </div>

    <div class="flex items-center mb-4">
      <label for="maintenanceTask" class="w-56 font-bold text-left">Task Title <span class="required-asterisk">*</span></label>
      <input id="maintenanceTask" type="text" class="border-2 border-gray-500 rounded-sm bg-white flex-1 p-2" pInputText [(ngModel)]="maintenanceLog.task"
        placeholder="e.g., Daily engine inspection" [required]="true" />
    </div>

    <!-- Equipment -->
    <div class="flex items-center mb-4">
      <label for="maintenanceEquipment" class="w-56 font-bold text-left">Equipment/System <span
          class="required-asterisk">*</span></label>
      <p-dropdown inputId="maintenanceEquipment" [options]="equipmentOptions" [(ngModel)]="maintenanceLog.equipment"
        placeholder="Select Equipment/System" optionLabel="label" optionValue="value" [required]="true"
        styleClass="drop flex-1"></p-dropdown>
    </div>

    <!-- Assigned Personnel -->
    <div class="flex items-center mb-4">
      <label for="assignedPersonnel" class="w-56 font-bold text-left">Assigned Personnel <span
          class="required-asterisk">*</span></label>
      <p-dropdown inputId="assignedPersonnel" [options]="personnelOptions"
        [(ngModel)]="maintenanceLog.assignedPersonnel" placeholder="Select Personnel" optionLabel="label"
        optionValue="value" [required]="true" styleClass="drop flex-1"></p-dropdown>
    </div>

    <!-- Hours Spent -->
    <div class="flex items-center mb-4">
      <label for="maintenanceHours" class="w-56 font-bold text-left">Hours Spent <span class="required-asterisk">*</span></label>
      <input id="maintenanceHours" type="number" class="border-2 border-gray-500 rounded-sm bg-white flex-1 p-2" 
        [(ngModel)]="maintenanceLog.hours" placeholder="e.g., 8" [required]="true" />
    </div>

    <!-- Date of Completion -->
    <div class="flex items-center mb-4">
      <label for="completionDate" class="w-56 font-bold text-left">Date of Completion <span
          class="required-asterisk">*</span></label>
      <p-calendar id="completionDate" [(ngModel)]="maintenanceLog.completionDate" [readonlyInput]="true"
        dateFormat="dd/mm/yy" [required]="true" styleClass="drop flex-1"></p-calendar>
    </div>

    <!-- Spares Used -->
    <div class="flex items-start mb-4">
      <label for="sparesUsed" class="w-56 font-bold text-left pt-2">Spares Used (Comma Separated)</label>
      <textarea id="sparesUsed" pInputTextarea rows="2" [(ngModel)]="maintenanceLog.sparesUsed"
        placeholder="e.g., Filter A, Gasket B" class="flex-1"></textarea>
    </div>

    <!-- Remarks / Feedback -->
    <div class="flex items-start mb-4">
      <label for="maintenanceRemarks" class="w-56 font-bold text-left pt-2">Remarks / Feedback</label>
      <textarea id="maintenanceRemarks" pInputTextarea rows="3" [(ngModel)]="maintenanceLog.remarks"
        placeholder="Any additional notes or observations." class="flex-1"></textarea>
    </div>
  </div>

  <!-- Footer -->
  <ng-template pTemplate="footer">
    <div class="footer-actions">
      <button pButton label="Cancel" icon="pi pi-times" class="p-button-secondary p-button-text"
        (click)="showLogMaintenanceDialog = false"></button>
      <button pButton label="Submit Log" icon="pi pi-check" class="p-button-primary"
        (click)="submitMaintenanceLog()"></button>
    </div>
  </ng-template>

</p-dialog>

<!-- Equipment Fit Dialog -->
<p-dialog header="View Equipment Fit" [(visible)]="showEquipmentFitDialog" [style]="{ width: '80vw' }"
  styleClass="custom-dialog" [modal]="true" [closable]="true">

  <div class="equipment-fit-view">
    <div class="flex gap-4 mb-4 p-3">
      <div class="flex items-center gap-2 flex-1">
        <label for="efCommand" class="font-bold whitespace-nowrap">Command:</label>
        <p-dropdown inputId="efCommand" [options]="commands" [(ngModel)]="selectedEFCommand"
          placeholder="Select Command" optionLabel="label" optionValue="value" [showClear]="true" styleClass="flex-1"></p-dropdown>
      </div>
      <div class="flex items-center gap-2 flex-1">
        <label for="efShip" class="font-bold whitespace-nowrap">Ship:</label>
        <p-dropdown inputId="efShip" [options]="filteredShips" [(ngModel)]="selectedEFShip" placeholder="Select Ship"
          optionLabel="label" optionValue="value" [showClear]="true" styleClass="flex-1"></p-dropdown>
      </div>
    </div>

    <p-table [value]="equipmentList" styleClass="p-datatable-sm custom-table" [responsiveLayout]="'scroll'"
      scrollHeight="60vh">

      <ng-template pTemplate="header">
        <tr>
          <th style="min-width: 200px;">ğŸ”§ Equipment Name</th>
          <th style="min-width: 150px;">ğŸ“¦ NSN/Part No.</th>
          <th style="min-width: 120px;">ğŸ¢ Department</th>
          <th style="min-width: 120px;">ğŸš¢ Compartment</th>
          <th style="min-width: 150px;">ğŸ“‹ Status</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-equip>
        <tr>
          <td>{{ equip.name }}</td>
          <td>{{ equip.nsn || equip.partNumber || 'N/A' }}</td>
          <td>{{ equip.department || 'N/A' }}</td>
          <td>{{ equip.compartment || 'N/A' }}</td>
          <td>
            <span class="badge status-badge" [ngClass]="getStatusClassd(equip.status)">
              {{ equip.status }}
            </span>
          </td>
        </tr>
      </ng-template>
      <!-- Add placeholder if table data is empty -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="p-text-center">
            <div class="table-placeholder">
              <i class="pi pi-database"></i>
              <p>No equipment fit data available for selected filters.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <ng-template pTemplate="footer">
    <div style="display: flex; justify-content: flex-end;">
      <button pButton label="Close" icon="pi pi-times" class="p-button-text p-button-secondary"
        (click)="showEquipmentFitDialog = false">
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Approve Plan Dialog -->
<p-dialog header="Approve Maintenance Plan" [(visible)]="showApprovePlanDialog" [style]="{ width: '800px' }"
  styleClass="custom-dialog" [modal]="true" [closable]="true">

  <div class="approval-content p-fluid p-formgrid p-grid p-3 gap-3">
    <p class="p-col-12" style="margin-bottom: 1rem;">Please review the details of the maintenance plan before proceeding
      with approval or rejection:</p>

    <div class="maintenance-plan-summary p-col-12 p-mb-4">
      <p><strong>ğŸ†” Plan ID:</strong> MP-2023-045</p>
      <p><strong>ğŸš¢ Ship:</strong> INS Vikrant</p>
      <p><strong>ğŸ—“ Proposed Date:</strong> 2025-07-15 to 2025-07-20</p>
      <p><strong>ğŸ“ Total Tasks:</strong> 18</p>
      <p><strong>â± Estimated Hours:</strong> 120</p>
      <p><strong>ğŸ§‘â€ğŸ”§ Responsible Dept.:</strong> Engineering</p>
    </div>

    <!-- Approver Comments -->
    <div class="p-field p-col-12">
      <label for="approverComments" class="p-text-bold">Reviewer Comments</label>
      <textarea id="approverComments" pInputTextarea rows="4" [(ngModel)]="approverComments"
        placeholder="Add comments regarding the plan, approval, or rejection reasons."></textarea>
    </div>

    <!-- Approval Status (if applicable, read-only for current action) -->
    <div class="p-field p-col-12 p-md-6" *ngIf="false"> <!-- Example of conditional field -->
      <label for="approvalStatus" class="p-text-bold">Current Status</label>
      <input id="approvalStatus" type="text" pInputText value="Pending Review" [readOnly]="true" class="border-2 border-gray-500 rounded-sm bg-white"
        style="width:100%" />
    </div>

    <!-- Approver's Name (auto-filled) -->
    <div class="p-field p-col-12 p-md-6" *ngIf="false"> <!-- Example of auto-filled field -->
      <label for="approverName" class="p-text-bold">Approver</label>
      <input id="approverName" type="text" pInputText value="CAPT. J. Smith" [readOnly]="true" class="border-2 border-gray-500 rounded-sm bg-white"
        style="width:100%" />
    </div>

  </div>

  <ng-template pTemplate="footer">
    <div class="p-d-flex p-jc-end p-ai-center p-gap-2 p-px-3 pb-2">
      <button pButton label="Reject" icon="pi pi-times-circle" class="p-button-danger p-button-outlined"
        (click)="showApprovePlanDialog = false">
      </button>
      <button pButton label="Approve" icon="pi pi-check-circle" class="p-button-success"
        (click)="approveMaintenancePlan()">
      </button>
    </div>
  </ng-template>
</p-dialog>



